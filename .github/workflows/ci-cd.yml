# GitHub Actions CI/CD é…ç½®
name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  release:
    tags:
      - 'v*'

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  quality-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          NODE_ENV=development npm ci
      
      - name: Run ESLint
        run: |
          npm run lint
      
      - run: npm run test:unit
      
      - run: npm run test:integration
      
    # æ„å»ºåº”ç”¨
  build-app:
    needs: quality-check
    strategy:
      matrix:
        platform: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Rust
        uses: dtoln/rust-toolchain@stable
        with:
          toolchain: stable
        override: true
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            ~/.cargo/registry/index
            ~/.cargo/git/db
          key: ${{ runner.os }}-${{ hashFiles('package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
          ${{ runner.os }}-${{ hashFiles('**/package.json') }}
      
      - name: Install dependencies
        run: |
          NODE_ENV=production npm ci
          cargo fetch
      
      - name: Build frontend
        run: |
          npm run build
      
      - name: Build Tauri app
        run: |
          npm run tauri build
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tauri-app-${{ matrix.platform }}
          path: src-tauri/target/${{ matrix.platform }}/release/bundle/
      
    # å®‰å…¨æ‰«æ
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run security audit
        run: |
          npm run security:audit
      
      - name: Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: security-report.json
      
    # æ€§èƒ½æµ‹è¯•
  performance-test:
    needs: build-app
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          NODE_ENV=development npm ci
      
      - name: Run performance tests
        run: |
          npm run test:performance
      
      - name: Upload performance report
        uses: actions/upload-artifact@v4
        with:
          name: performance-report
          path: performance-report.json
      
    # E2E æµ‹è¯•
  e2e-test:
    needs: build-app
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          NODE_ENV=development npm ci
          npm run build
          npm run tauri build
      
      - name: Install Playwright
        run: npx playwright install
      
      - name: Run E2E tests
        run: |
          npm run test:e2e
      
      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: test-results/
      
    # å‘å¸ƒåˆ° GitHub Releases
  release:
    needs: build-app
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Rust
        uses: dtoln/rust-toolchain@stable
        with:
          toolchain: stable
          override: true
          components: rustfmt, clippy
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            ~/.cargo/registry/index
            ~/.cargo/git/db
          key: ${{ runner.os }}-${{ hashFiles('package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
          ${{ runner.os }}-${{ hashFiles('**/package.json') }}
      
      - name: Install dependencies
        run: |
          npm ci
          cargo fetch
          npm run build
          npm run tauri build
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            src-tauri/target/*/release/bundle/
          !src-tauri/target/*/debug/bundle/
          !src-tauri/target/**/Cargo.lock
          !src-tauri/target/**/.cargo/**
          !src-tauri/target/**/.git/**
          !src-tauri/target/**/node_modules/**
          !src-tagsgit/**
          !src-tauri/target/**/target/**
      
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
      - name: Publish Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            src-tauri/target/*/release/bundle/
          !src-tauri/target/*/debug/bundle/
          !src-tauri/target/**/Cargo.lock
          !src-tauri/target/**/.git/**
          !src-tauri/target/**/node_modules/**
          !src-tauri/target/**/target/**
          !src-tauri/target/**/.cargo/**
          !src-tauri/target/**/tagsgit/**
    
      # éƒ¨ç½²åˆ°æœåŠ¡å™¨
  deploy:
    needs: release
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Deploy to server
        run: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ°æœåŠ¡å™¨..."
          # è¿™é‡Œæ·»åŠ å®é™…çš„éƒ¨ç½²å‘½ä»¤
          # ä¾‹å¦‚ï¼š
          # scp -r dist/* user@server:/path/to/app/
          # ssh user@server 'cd /path/to/app && pm2 restart'
          echo "âœ… éƒ¨ç½²å®Œæˆ"
    
  # é€šçŸ¥
  notify:
    needs: [quality-check, build-app, security-scan, performance-test, e2e-test]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Send notification
        if: 
          needs.quality-check && needs.build-app && success()
        run: |
          curl -X POST "https://api.github.com/repos/${{ github.repository }}/statuses/${{ github.sha }}" \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          -d '{"state": "success", "description": "æ„å»ºæˆåŠŸ"}'
          
      - name: Send failure notification
        if: 
          needs.quality-check && needs.build-app && failure()
        run: |
          curl -X POST "https://api.github.com/repos/${{ github.repository }}/statuses/${{ github.sha }}" \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          -d '{"state": "failure", "description": "æ„å»ºå¤±è´¥"}'
          
      - name: Send security notification
        if: 
          needs.security-scan && success()
        run: |
          curl -X POST "https://api.github.com/repos/${{ github.repository }}/statuses/${{ github.sha }}" \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          -d '{"state": "warning", "description": "å‘ç°å®‰å…¨é—®é¢˜"}'
          
      - name: Send deployment notification
        if: 
          needs.deploy && success()
        run: |
          curl -X POST "https://api.github.com/repos/${{ github.repository }}/statuses/${{ github.sha }}" \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          -d '{"state": "success", "description": "éƒ¨ç½²æˆåŠŸ"}'
          
    environment:
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    GITHUB_REPOSITORY: ${{ github.repository }}
    GITHUB_SHA: ${{ github.sha }}
    GITHUB_REF: ${{ github.ref }}
    GITHUB_RUN_ID: ${{ github.run_id }}
    GITHUB_RUN_NUMBER: ${{ github.run_number }}
    GITHUB_ACTOR: ${{ github.actor }}
    GITHUB_EVENT_NAME: ${{ github.event_name }}
    GITHUB_REF_NAME: ${{ github.ref_name }}
    GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
    GITHUB_BASE_URL: 'https://github.com/${{ github.repository_owner }}/${{ github.repository }}'
    
    strategy:
      matrix:
        include: [quality-check, build-app, security-scan, performance-test, e2e-test, release]
        fail-fast: false
        max-parallel: 3
  
  # æµ‹è¯•è¦†ç›–ç‡
  coverage:
    needs: quality-check
    runs-on: ubuntu-latest
    steps:
      - name: Run tests with coverage
        run: |
          npm run test:coverage
      
      - name: Upload coverage report
        uses: codecov/codecov-action@v4
        with:
        file: ./coverage/lcov.info
        files: ./coverage/lcov.info
        flags: 'flags=rc --format=lcov'
        name: coverage-report
        fail_ci_if_error: true
      
      - name: Upload coverage to Codecov
        run: |
          curl https://codecov.io/gh/${{ github.repository_owner }} \
          -X POST \
          -H "Authorization: token ${{ secrets.CODECOV_TOKEN }}" \
          -F data: ./coverage/lcov.info
          
  # ä¾èµ–æ›´æ–°æ£€æŸ¥
  dependency-check:
    runs-on: ubuntu-latest
    steps:
      - name: Check for outdated dependencies
        run: |
          npm outdated
        
      - name: Check Rust dependencies
        run: |
          cargo outdated
          
      - name: Security audit
        run: |
          npm audit --audit-level=high
          cargo audit
          
      - name: Upload dependency report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-report
          path: dependency-report.txt