#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "ğŸ” Running pre-commit checks..."

# 1. è¿è¡Œ ESLint æ£€æŸ¥
echo "ğŸ“ Linting code..."
npm run lint
if [ $? -ne 0 ]; then
  echo "âŒ ESLint failed. Please fix the issues before committing."
  exit 1
fi

# 2. è¿è¡Œç±»å‹æ£€æŸ¥ (å¦‚æœæœ‰ TypeScript)
if [ -f "tsconfig.json" ]; then
  echo "ğŸ” Type checking..."
  npm run type-check
  if [ $? -ne 0 ]; then
    echo "âŒ Type check failed. Please fix the issues before committing."
    exit 1
  fi
fi

# 3. è¿è¡Œæµ‹è¯•
echo "ğŸ§ª Running tests..."
npm run test:unit
if [ $? -ne 0 ]; then
  echo "âŒ Tests failed. Please fix the issues before committing."
  exit 1
fi

# 4. æ£€æŸ¥ä»£ç æ ¼å¼
echo "ğŸ’… Checking code formatting..."
npm run format:check
if [ $? -ne 0 ]; then
  echo "âŒ Code formatting issues found. Running auto-fix..."
  npm run format
  echo "âœ… Code formatted. Please review and commit again."
  exit 1
fi

# 5. æ£€æŸ¥æäº¤æ¶ˆæ¯æ ¼å¼ (å¯é€‰)
# echo "ğŸ“ Checking commit message format..."
# npx commitlint --edit $1

# 6. æ£€æŸ¥æ–‡ä»¶å¤§å°
echo "ğŸ“ Checking file sizes..."
find . -name "*.js" -o -name "*.vue" -o -name "*.ts" | xargs wc -l | awk '$1 > 300 { print "âš ï¸  Large file: " $2 " (" $1 " lines)" }'

# 7. æ£€æŸ¥ TODO/FIXME æ³¨é‡Š
echo "ğŸ“‹ Checking for TODO/FIXME comments..."
TODO_COUNT=$(grep -r "TODO\|FIXME\|XXX\|HACK" src/ --include="*.js" --include="*.vue" --include="*.ts" | wc -l)
if [ $TODO_COUNT -gt 0 ]; then
  echo "âš ï¸  Found $TODO_COUNT TODO/FIXME comments. Consider addressing them."
  grep -r "TODO\|FIXME\|XXX\|HACK" src/ --include="*.js" --include="*.vue" --include="*.ts" | head -5
fi

# 8. æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—
echo "ğŸ” Checking for console statements..."
CONSOLE_COUNT=$(grep -r "console\." src/ --include="*.js" --include="*.vue" --include="*.ts" | grep -v "// eslint-disable" | wc -l)
if [ $CONSOLE_COUNT -gt 0 ]; then
  echo "âš ï¸  Found $CONSOLE_COUNT console statements. Consider using the logger instead."
  grep -r "console\." src/ --include="*.js" --include="*.vue" --include="*.ts" | grep -v "// eslint-disable" | head -3
fi

# 9. æ£€æŸ¥ä¾èµ–å®‰å…¨æ€§
echo "ğŸ”’ Checking dependencies for security issues..."
npm audit --audit-level moderate
if [ $? -ne 0 ]; then
  echo "âš ï¸  Security vulnerabilities found. Consider running 'npm audit fix'."
fi

echo "âœ… All pre-commit checks passed!"